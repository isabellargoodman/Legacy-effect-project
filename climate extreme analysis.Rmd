---
title: "productivty density"
output: html_document
date: "2023-05-09"
---
---
title: "drought"
output: html_document
date: "2023-04-04"
---

```{r}
#Load libraries 
library(dplyr)
library(tidyr)
library(tidyverse)
library(data.table)
library(ggpubr)

#Load data
setwd("~/Desktop")
legacydata<-readRDS("legacydata.rds")
```


```{r}
#Separate by ecoregion
cali_ecoregion<-legacydata[legacydata$ecoregion=='cali',]

oops<-legacydata%>%
  filter(ecoregion=="cali")

#Create "lead" variable for NPP, PPT, so current year can be compared to following year 
cali_ecoregion$leadNPP<-as.numeric(lead(cali_ecoregion$NPP, 35755))
cali_ecoregion$leadPPT<-as.numeric(lead(cali_ecoregion$PPT, 35755))

#Repeat for all ecoregions 
cold_ecoregion<-legacydata[legacydata$ecoregion=='cold',]
cold_ecoregion$leadNPP<-as.numeric(lead(cold_ecoregion$NPP, 324062))
cold_ecoregion$leadPPT<-as.numeric(lead(cold_ecoregion$PPT, 324062))

northern_ecoregion<-legacydata[legacydata$ecoregion=='northern',]
northern_ecoregion$leadNPP<-as.numeric(lead(northern_ecoregion$NPP, 312160))
northern_ecoregion$leadPPT<-as.numeric(lead(northern_ecoregion$PPT, 312160))

sgs_ecoregion<-legacydata[legacydata$ecoregion=="sgs",]
sgs_ecoregion$leadNPP<-as.numeric(lead(sgs_ecoregion$NPP, 122179))
sgs_ecoregion$leadPPT<-as.numeric(lead(sgs_ecoregion$PPT, 122179))

hot_ecoregion<-legacydata[legacydata$ecoregion=='hot',]
hot_ecoregion$leadNPP<-as.numeric(lead(hot_ecoregion$NPP, 143420))
hot_ecoregion$leadPPT<-as.numeric(lead(hot_ecoregion$PPT, 143420))

#Merge data 
prod_data<-rbind(hot_ecoregion,cali_ecoregion,cold_ecoregion,northern_ecoregion,sgs_ecoregion)
prod_data<-subset(prod_data,select=-c(afgNPP,pfgNPP,shrNPP,treNPP,lagTEMPdev))
prod_data%>%
  drop_na()

#Export data as .rds file
write_rds(prod_data, "prod_data.rds")

setwd("~/Desktop")
prod_data<-readRDS("prod_data.rds")
```

```{r}
#Calculate deviation from the pixel mean for each observation
lowprod_data <- prod_data 

#Calculate NPP standard deviation for each pixel, merge datasets
lowprod_data <- lowprod_data %>%
  group_by(x, y, ecoregion) %>%
  mutate(PPTsd = sd(PPT))

#Calculate minimum and maximum NPP values (mean+/- 1 sd) for later use
lowprod_data <- lowprod_data %>%
  mutate(PPTmin = MAP - PPTsd,
         PPTmax = MAP + PPTsd)

#Select only observations that have the lowest deviation from the pixel mean
lowprod_data_mins<-lowprod_data%>%
  group_by(x,y,ecoregion)%>%
 slice(which.min(NPPdev))

#Remove observations that have the following year production (leadNPP) greater or less than 1 sd from the mean, to avoid multi year extraordinarily unproductive years
lowprod_data_mins <- lowprod_data_mins %>%
  filter(leadPPT > PPTmin & leadPPT < PPTmax)

lowprod_data_mins <- lowprod_data_mins %>%
  mutate(leadNPPdev = leadNPP - NPPpixmean)
```

**Repeat the process to find extrodinarily high productivity years, and extrodinarily wet and dry years.** 
```{r}
#Import productivity data and duplicate it renaming it to highprod_data, repeat process this time taking the observations with the highest deviation from the mean
highprod_data <- prod_data 

highprod_data <- highprod_data %>%
  group_by(x,y,ecoregion) %>%
  mutate(MAP = mean(PPT, na.rm = TRUE))

#Calculate NPP standard deviation for each pixel, merge datasets
highprod_data <- highprod_data %>%
  group_by(x, y, ecoregion) %>%
  mutate(PPTsd = sd(PPT))

#Calculate minimum and maximum NPP values (mean+/- 1 sd) for later use
highprod_data <- highprod_data %>%
  mutate(PPTmin = MAP - PPTsd,
         PPTmax = MAP + PPTsd)

#Select only observations that have the highest deviation from the pixel mean
highprod_data_maxs<-highprod_data%>%
  group_by(x,y,ecoregion)%>%
 slice(which.max(NPPdev))

#Remove observations that have the following year production (leadNPP) greater or less than 1 sd from the mean, to avoid multi year extraordinarily unproductive years
highprod_data_maxs <- highprod_data_maxs %>%
  filter(leadPPT > PPTmin & leadPPT < PPTmax)

highprod_data_maxs <- highprod_data_maxs %>%
  mutate(leadNPPdev = leadNPP - NPPpixmean)
```

```{r}
#Label data with productivity conditions and merge datasets
lowprod_data_mins$condition<-'Low Productivity'
highprod_data_maxs$condition<-'High Productivity'
productivityconditions<-rbind(lowprod_data_mins,highprod_data_maxs)
```

```{r}
#Create productivity figure
productivityhist<-ggplot(productivityconditions, aes(leadNPPdev, fill=condition))+
  geom_density(data=productivityconditions, aes(x=leadNPPdev, fill=condition, after_stat(scaled)), alpha=.7)+
  scale_fill_manual(values = c("darkolivegreen4", "wheat2"),labels = c("High Productivity", "Low Productivity"))+
  scale_x_continuous(limits = c(-250, 250))+
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  labs(fill = "Previous-year Condition") +
  scale_y_continuous(expand = c(0,0),limits = c(0,1.01))+
  ylab("Probability Density")+
  xlab("NPP Anomaly")+
  theme(axis.title.x =element_text( size=18),
        axis.title.y = element_text(size=18),
        axis.text.x = element_text(size=14),
        axis.text.y = element_text(size=14))+
  theme(legend.position = c(.8,.5))+
  theme(
    strip.background =element_rect(fill="white"),
    strip.text = element_text(size=17),
    panel.background = element_rect(fill=NA),
    panel.border = element_blank(), 
    axis.line.x = element_line(colour = "black"),
    axis.line.y = element_line(colour = "black"))+
  theme(legend.key.size = unit(.75, 'cm'), 
        legend.title = element_text(size=14), 
        legend.text = element_text(size=12))
productivityhist
```

```{r}
droughtdata <- prod_data
droughtdata <- droughtdata %>%
  group_by(x,y,ecoregion) %>%
  mutate(MAP = mean(PPT, na.rm = TRUE))

#Calculate NPP standard deviation for each pixel, merge datasets
droughtdata <- droughtdata %>%
  group_by(x, y, ecoregion) %>%
  mutate(PPTsd = sd(PPT))

#Calculate minimum and maximum NPP values (mean+/- 1 sd) for later use
droughtdata <- droughtdata %>%
  mutate(PPTmin = MAP - PPTsd,
         PPTmax = MAP + PPTsd)

#Select only observations that have the highest deviation from the pixel mean
droughtdata_mins<-droughtdata%>%
  group_by(x,y,ecoregion)%>%
 slice(which.min(PPTdev))

#Remove observations that have the following year production (leadNPP) greater or less than 1 sd from the mean, to avoid multi year extraordinarily unproductive years
droughtdata_mins <- droughtdata_mins %>%
  filter(leadPPT > PPTmin & leadPPT < PPTmax)

droughtdata_mins <- droughtdata_mins %>%
  mutate(leadNPPdev = leadNPP - NPPpixmean)
```

```{r}
wetdata <- prod_data
wetdata <- wetdata %>%
  group_by(x,y,ecoregion) %>%
  mutate(MAP = mean(PPT, na.rm = TRUE))

#Calculate NPP standard deviation for each pixel, merge datasets
wetdata <- wetdata %>%
  group_by(x, y, ecoregion) %>%
  mutate(PPTsd = sd(PPT))

#Calculate minimum and maximum NPP values (mean+/- 1 sd) for later use
wetdata <- wetdata %>%
  mutate(PPTmin = MAP - PPTsd,
         PPTmax = MAP + PPTsd)

#Select only observations that have the highest deviation from the pixel mean
wetdata_max<-wetdata%>%
  group_by(x,y,ecoregion)%>%
 slice(which.max(PPTdev))

#Remove observations that have the following year production (leadNPP) greater or less than 1 sd from the mean, to avoid multi year extraordinarily unproductive years
wetdata_max <- wetdata_max %>%
  filter(leadPPT > PPTmin & leadPPT < PPTmax)

wetdata_max <- wetdata_max %>%
  mutate(leadNPPdev = leadNPP - NPPpixmean)
```

```{r}
wetdata_max$condition<-'Wet'
droughtdata_mins$condition<-'Dry'
droughtconditions<-rbind(wetdata_max,droughtdata_mins)
```

```{r}
#Create drought figure
droughthist<-ggplot(droughtconditions, aes(leadNPPdev, fill=condition))+
  geom_density(data=droughtconditions, aes(x=leadNPPdev, fill=condition, after_stat(scaled)), alpha=.7)+
  scale_fill_manual(values = c("wheat2", "darkolivegreen4"))+
  scale_x_continuous(limits = c(-250, 250))+
  ylab("Probability Density")+
  xlab("NPP Anomaly")+
  labs(fill = "Previous-year Condition") +
  scale_y_continuous(expand = c(0,0),limits = c(0,1))+
  theme(axis.title.x =element_text( size=18),
        axis.title.y = element_text(size=18),
        axis.text.x = element_text(size=14),
        axis.text.y = element_text(size=14))+
  theme(legend.position = c(.8,.5))+
  theme(
    strip.background =element_rect(fill="white"),
    strip.text = element_text(size=15),
    panel.background = element_rect(fill=NA),
    panel.border = element_blank(), 
    axis.line.x = element_line(colour = "black"),
    axis.line.y = element_line(colour = "black"))+
  theme(legend.key.size = unit(.75, 'cm'), 
        legend.title = element_text(size=14), 
        legend.text = element_text(size=12))
droughthist
```


```{r}
#Create figure showing bivariate relationship between PPT deviation and following year in extremely wet/dry years. 
bivariatedrought<-ggplot(data=droughtconditions, aes(x=PPTdev, y=leadNPPdev))+
  geom_point(alpha=.5, pch=19, size=.4)+
  geom_abline(intercept=0,slope=1, color="red")+
  ylab("NPP Anomaly in Following Year")+
  xlab("PPT Anomaly in Extreme Precipitation Years")+
  scale_y_continuous(expand = c(0,0),limits = c(-700,1200))+
  scale_x_continuous(expand = c(0,0),limits = c(-700,1200))+
    theme(
    strip.background =element_rect(fill="white"),
    strip.text = element_text(size=15),
    panel.background = element_rect(fill=NA),
    panel.border = element_blank(),
    axis.line.x = element_line(colour = "black"),
    axis.line.y = element_line(colour = "black"),
    axis.ticks = element_blank())+
  theme(axis.title.x =element_text(size=18),
        axis.title.y = element_text(size=18),
        axis.text.y=element_text(size=18),
        axis.text.x=element_text(size=18))
bivariatedrought
```

```{r}
#Create figure showing bivariate relationship between NPP deviation and following year NPP deviation in extremely productive/unproductive years. 
bivariateprod<-ggplot(data=productivityconditions, aes(x=NPPdev, y=leadNPPdev))+
  geom_point(alpha=.5, pch=19, size=.4)+
  ylab("NPP Anomaly in Following Year")+
  xlab("NPP Anomaly in Extreme Productivity Years")+
  geom_abline(intercept=0,slope=1,color="red")+
  scale_y_continuous(expand = c(0,0),limits = c(-500,600))+
  scale_x_continuous(expand = c(0,0),limits = c(-500,600))+

    theme(
    strip.background =element_rect(fill="white"),
    strip.text = element_text(size=15),
    panel.background = element_rect(fill=NA),
    panel.border = element_blank(), 
    axis.line.x = element_line(colour = "black"),
    axis.line.y = element_line(colour = "black"),
    axis.ticks = element_blank())+
  theme(axis.title.x =element_text(size=18),
        axis.title.y = element_text(size=18),
        axis.text.y=element_text(size=18),
        axis.text.x=element_text(size=18))
bivariateprod
```

```{r}
library(ggpubr)
jpeg("fig 5.jpeg",
     width=14,
     height=10,
     units="in",
     res=300)
figure5_4panel<-ggarrange(droughthist,bivariatedrought,productivityhist,bivariateprod,
          nrow=2, ncol=2, labels=c("(a)","(b)","(c)","(d)"))
figure5_4panel
dev.off()
```

**Create supporting figure 4** 
```{r}
#Separate productivity data by ecoregion 
cali_ecoregion<-productivityconditions[productivityconditions$ecoregion=='cali',]
cold_ecoregion<-productivityconditions[productivityconditions$ecoregion=='cold',]
northern_ecoregion<-productivityconditions[productivityconditions$ecoregion=='northern',]
sgs_ecoregion<-productivityconditions[productivityconditions$ecoregion=='sgs',]
hot_ecoregion<-productivityconditions[productivityconditions$ecoregion=='hot',]
```

```{r}
#Graph data for each ecoregion individually
caliprod<-ggplot(cali_ecoregion, aes(leadNPPdeviation, fill=condition, after_stat(scaled)), alpha=.7)+
  geom_density(bins=40,color= "#000000", alpha=.7)+
  scale_fill_manual(values = c("darkolivegreen4", "wheat2"),labels = c("High Productivity", "Low Productivity"))+
  scale_x_continuous(limits = c(-150, 150))+
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("California Annuals")+
  labs(fill = "Previous-year Condition") +
  scale_y_continuous(expand = c(0,0),limits = c(0,1))+
  theme(title = element_text(size=16))+
  theme(legend.position = c(.85,.7))+
  theme(
    strip.background =element_rect(fill="white"),
    strip.text = element_text(size=17),
    panel.background = element_rect(fill=NA),
    panel.border = element_blank(),
    axis.line.x = element_line(colour = "black"),
    axis.line.y = element_line(colour = "black"))+
  theme(legend.key.size = unit(.75, 'cm'),
        legend.title = element_text(size=12),
        legend.text = element_text(size=10))
caliprod

coldprod<-ggplot(cold_ecoregion, aes(leadNPPdeviation, fill=condition,after_stat(scaled)), alpha=.7)+
  geom_density(bins=40,color= "#000000", alpha=.7)+
  scale_fill_manual(values = c("darkolivegreen4", "wheat2"),labels = c("High Productivity", "Low Productivity"))+
  scale_x_continuous(limits = c(-150, 150))+
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("Cold Deserts")+
  labs(fill = "Previous-year Condition") +
  scale_y_continuous(expand = c(0,0),limits = c(0,1))+
  theme(title = element_text(size=16))+
  theme(legend.position = c(.85,.7))+
  theme(
    strip.background =element_rect(fill="white"),
    strip.text = element_text(size=17),
    panel.background = element_rect(fill=NA),
    panel.border = element_blank(), 
    axis.line.x = element_line(colour = "black"),
    axis.line.y = element_line(colour = "black"))+
  theme(legend.key.size = unit(.75, 'cm'), 
        legend.title = element_text(size=12),
        legend.text = element_text(size=10))
coldprod

nsprod<-ggplot(northern_ecoregion, aes(leadNPPdeviation, fill=condition,after_stat(scaled)), alpha=.7)+
  geom_density(bins=40,color= "#000000", alpha=.7)+
  scale_fill_manual(values = c("darkolivegreen4", "wheat2"),labels = c("High Productivity", "Low Productivity"))+
  scale_x_continuous(limits = c(-150, 150))+
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("Northern Mixed Prairies")+
  labs(fill = "Previous-year Condition") +
  scale_y_continuous(expand = c(0,0),limits = c(0,1))+
  theme(title = element_text(size=16))+
  theme(legend.position = c(.85,.7))+
  theme(
    strip.background =element_rect(fill="white"),
    strip.text = element_text(size=17),
    panel.background = element_rect(fill=NA),
    panel.border = element_blank(),
    axis.line.x = element_line(colour = "black"),
    axis.line.y = element_line(colour = "black"))+
  theme(legend.key.size = unit(.75, 'cm'), 
        legend.title = element_text(size=12),
        legend.text = element_text(size=10))
nsprod

sgsprod<-ggplot(sgs_ecoregion, aes(leadNPPdeviation, fill=condition,after_stat(scaled)), alpha=.7)+
  geom_density(bins=40,color= "#000000", alpha=.7)+
  scale_fill_manual(values = c("darkolivegreen4", "wheat2"),labels = c("High Productivity", "Low Productivity"))+
  scale_x_continuous(limits = c(-150, 150))+
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("Shortgrass Steppe")+
  labs(fill = "Previous-year Condition") +
  scale_y_continuous(expand = c(0,0),limits = c(0,1))+
  theme(title = element_text(size=16))+
  theme(legend.position = c(.85,.7))+
  theme(
    strip.background =element_rect(fill="white"),
    strip.text = element_text(size=17),
    panel.background = element_rect(fill=NA),
    panel.border = element_blank(), 
    axis.line.x = element_line(colour = "black"),
    axis.line.y = element_line(colour = "black"))+
  theme(legend.key.size = unit(.75, 'cm'), 
        legend.title = element_text(size=12), 
        legend.text = element_text(size=10))
sgsprod

hotprod<-ggplot(hot_ecoregion, aes(leadNPPdeviation, fill=condition,after_stat(scaled)), alpha=.7)+
  geom_density(bins=40,color= "#000000", alpha=.7)+
  scale_fill_manual(values = c("darkolivegreen4", "wheat2"),labels = c("High Productivity", "Low Productivity"))+
  scale_x_continuous(limits = c(-150, 150))+
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("Hot Desert")+
  labs(fill = "Previous-year Condition") +
  scale_y_continuous(expand = c(0,0),limits = c(0,1))+
  theme(title = element_text(size=16))+
  theme(legend.position = c(.85,.7))+
  theme(
    strip.background =element_rect(fill="white"),
    strip.text = element_text(size=17),
    panel.background = element_rect(fill=NA),
    panel.border = element_blank(),
    axis.line.x = element_line(colour = "black"),
    axis.line.y = element_line(colour = "black"))+
  theme(legend.key.size = unit(.75, 'cm'), 
        legend.title = element_text(size=12), 
        legend.text = element_text(size=10))
hotprod

```

```{r}
#Separate drought data by ecoregion
cali_drought<-droughtconditions[droughtconditions$ecoregion=='cali',]
cold_drought<-droughtconditions[droughtconditions$ecoregion=='cold',]
northern_drought<-droughtconditions[droughtconditions$ecoregion=='northern',]
sgs_drought<-droughtconditions[droughtconditions$ecoregion=='sgs',]
hot_drought<-droughtconditions[droughtconditions$ecoregion=='hot',]

```

```{r}
#Graph drought data for each ecoregion specifically
calidrought<-ggplot(cali_drought, aes(leadNPPdeviation, fill=condition,after_stat(scaled)), alpha=.7)+
  geom_density(bins=40,color= "#000000", alpha=.7)+
  scale_fill_manual(values = c("wheat2", "darkolivegreen4"))+
  scale_x_continuous(limits = c(-150, 150))+
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("California Annuals")+
  labs(fill = "Previous-year Condition") +
  scale_y_continuous(expand = c(0,0),limits = c(0,1))+
  theme(title = element_text(size=16))+
  theme(legend.position = c(.85,.7))+
  theme(plot.margin = margin(0,0,0,1,"cm"),
    strip.background =element_rect(fill="white"),
    strip.text = element_text(size=17),
    panel.background = element_rect(fill=NA),
    panel.border = element_blank(), 
    axis.line.x = element_line(colour = "black"),
    axis.line.y = element_line(colour = "black"))+
  theme(legend.key.size = unit(.75, 'cm'),
        legend.title = element_text(size=12),
        legend.text = element_text(size=10))
calidrought

colddrought<-ggplot(cold_drought, aes(leadNPPdeviation, fill=condition,after_stat(scaled)), alpha=.7)+
  geom_density(bins=40,color= "#000000", alpha=.7)+
  scale_fill_manual(values = c("wheat2", "darkolivegreen4"))+
  scale_x_continuous(limits = c(-150, 150))+
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("Cold Desert")+
  labs(fill = "Previous-year Condition") +
  scale_y_continuous(expand = c(0,0),limits = c(0,1))+
  theme(title = element_text(size=16))+
  theme(legend.position = c(.85,.7))+
  theme(plot.margin = margin(0,0,0,1,"cm"),
    strip.background =element_rect(fill="white"),
    strip.text = element_text(size=17),
    panel.background = element_rect(fill=NA),
    panel.border = element_blank(),
    axis.line.x = element_line(colour = "black"),
    axis.line.y = element_line(colour = "black"))+
  theme(legend.key.size = unit(.75, 'cm'), 
        legend.title = element_text(size=12),
        legend.text = element_text(size=10))
colddrought

nsdrought<-ggplot(northern_drought, aes(leadNPPdeviation, fill=condition,after_stat(scaled)), alpha=.7)+
  geom_density(bins=40,color= "#000000", alpha=.65)+
  scale_fill_manual(values = c("wheat2", "darkolivegreen4"))+
  scale_x_continuous(limits = c(-150, 150))+
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("Northern Mixed Prairies")+
  labs(fill = "Previous-year Condition") +
  scale_y_continuous(expand = c(0,0),limits = c(0,1))+
  theme(title = element_text(size=16))+
  theme(legend.position = c(.85,.7))+
  theme(plot.margin = margin(0,0,0,1,"cm"),
    strip.background =element_rect(fill="white"),
    strip.text = element_text(size=17),
    panel.background = element_rect(fill=NA),
    panel.border = element_blank(), 
    axis.line.x = element_line(colour = "black"),
    axis.line.y = element_line(colour = "black"))+
  theme(legend.key.size = unit(.75, 'cm'),
        legend.title = element_text(size=12), 
        legend.text = element_text(size=10))
nsdrought

sgsdrought<-ggplot(sgs_drought, aes(leadNPPdeviation, fill=condition,after_stat(scaled)), alpha=.7)+
  geom_density(bins=40,color= "#000000", alpha=.7)+
  scale_fill_manual(values = c("wheat2", "darkolivegreen4"))+
  scale_x_continuous(limits = c(-150, 150))+
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("Shortgrass Steppe")+
  labs(fill = "Previous-year Condition") +
  scale_y_continuous(expand = c(0,0),limits = c(0,1))+
  theme(title = element_text(size=16))+
  theme(legend.position = c(.85,.7))+
  theme(plot.margin = margin(0,0,0,1,"cm"),
    strip.background =element_rect(fill="white"),
    strip.text = element_text(size=17),
    panel.background = element_rect(fill=NA),
    panel.border = element_blank(), 
    axis.line.x = element_line(colour = "black"),
    axis.line.y = element_line(colour = "black"))+
  theme(legend.key.size = unit(.75, 'cm'), 
        legend.title = element_text(size=12), 
        legend.text = element_text(size=10))
sgsdrought

hotdrought<-ggplot(hot_drought, aes(leadNPPdeviation, fill=condition,after_stat(scaled)), alpha=.7)+
  geom_density(bins=40,color= "#000000", alpha=.7)+
  scale_fill_manual(values = c("wheat2", "darkolivegreen4"))+
  scale_x_continuous(limits = c(-150, 150))+
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  ggtitle("Hot Desert")+
  labs(fill = "Previous-year Condition") +
  scale_y_continuous(expand = c(0,0),limits = c(0,1))+
  theme(title = element_text(size=16))+
  theme(legend.position = c(.85,.7))+
  theme(plot.margin = margin(0,0,0,1,"cm"),
    strip.background =element_rect(fill="white"),
    strip.text = element_text(size=17),
    panel.background = element_rect(fill=NA),
    panel.border = element_blank(), 
    axis.line.x = element_line(colour = "black"),
    axis.line.y = element_line(colour = "black"))+
  theme(legend.key.size = unit(.75, 'cm'),
        legend.title = element_text(size=12),
        legend.text = element_text(size=10))
hotdrought

```

```{r}
#Combine figures and export
jpeg("supporting fig 4.jpeg",
     width=16,
     height=16,
     units="in",
     res=300)
supporting_fig4<-ggarrange(calidrought+rremove("ylab") + rremove("xlab"),  caliprod+rremove("ylab") + rremove("xlab"),  colddrought+rremove("ylab") + rremove("xlab"),coldprod+rremove("ylab") + rremove("xlab"), nsdrought+rremove("ylab") + rremove("xlab"),nsprod+rremove("ylab") + rremove("xlab"), sgsdrought+rremove("ylab") + rremove("xlab"), sgsprod+rremove("ylab") + rremove("xlab"), hotdrought+rremove("ylab") + rremove("xlab") ,hotprod+rremove("ylab") + rremove("xlab"),
          nrow=5, ncol=2)

supporting_fig4<-annotate_figure(supporting_fig4, left=text_grob("Probability Density", rot=90, vjust=1, face="bold", size=20),bottom=text_grob("Current-Year NPP Anomaly", face="bold", size=20))

supporting_fig4
dev.off()
```


```{r}
#Calculate Spearmans coefficient values
cor(lowprod_data_mins$NPPdev,lowprod_data_mins$leadNPPdev, method=c("spearman"))
cor(highprod_data_maxs$NPPdev,highprod_data_maxs$leadNPPdev, method=c("spearman"))

cor(droughtdata_mins$PPTdev,droughtdata_mins$leadNPPdev, method=c("spearman"))
cor(wetdata_max$PPTdev,wetdata_max$leadNPPdev, method=c("spearman"))

cor(productivityconditions$NPPdev,productivityconditions$leadNPPdev, method=c("spearman"))
cor(droughtconditions$PPTdev,droughtconditions$leadNPPdev, method=c("spearman"))

```
